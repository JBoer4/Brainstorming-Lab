<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budget App</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a2e">
</head>
<body>
  <h1>Budget App</h1>
  <input type="text" id="test" value="" placeholder="type something...">
  <p id="status">Loading...</p>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }

    // --- IndexedDB helpers ---
    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open('budget-app', 1);
        req.onupgradeneeded = () => req.result.createObjectStore('kv');
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function localGet(key) {
      const db = await openDB();
      return new Promise((resolve) => {
        const tx = db.transaction('kv', 'readonly');
        const req = tx.objectStore('kv').get(key);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(undefined);
      });
    }

    async function localSet(key, value) {
      const db = await openDB();
      return new Promise((resolve) => {
        const tx = db.transaction('kv', 'readwrite');
        tx.objectStore('kv').put(value, key);
        tx.oncomplete = () => resolve();
      });
    }

    // --- Sync ---
    let pendingSync = false;

    async function syncFromServer() {
      try {
        const res = await fetch('/api/data');
        if (res.ok) return await res.json();
      } catch {}
      return null;
    }

    async function syncToServer(data) {
      try {
        const res = await fetch('/api/data', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          pendingSync = false;
          status.textContent = 'Saved & synced';
          return true;
        }
      } catch {}
      pendingSync = true;
      status.textContent = 'Saved locally — will sync when online';
      return false;
    }

    // Retry pending sync every 30 seconds
    setInterval(async () => {
      if (!pendingSync) return;
      const data = await localGet('data');
      if (data) await syncToServer(data);
    }, 30000);

    // Also retry when the browser comes back online
    window.addEventListener('online', async () => {
      if (!pendingSync) return;
      const data = await localGet('data');
      if (data) await syncToServer(data);
    });

    // --- App ---
    const input = document.getElementById('test');
    const status = document.getElementById('status');

    async function load() {
      const serverData = await syncFromServer();
      const localData = await localGet('data');

      const data = serverData || localData || { text: 'it works' };
      input.value = data.text;
      await localSet('data', data);

      if (serverData) {
        status.textContent = 'Synced with server';
      } else if (localData) {
        pendingSync = true;
        status.textContent = 'Offline — using local data';
      } else {
        status.textContent = 'Fresh start';
      }
    }

    let saveTimeout;
    input.addEventListener('input', () => {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        const data = { text: input.value };
        await localSet('data', data);
        await syncToServer(data);
      }, 500);
    });

    load();
  </script>
</body>
</html>